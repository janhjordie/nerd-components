@using Microsoft.JSInterop
@inject IJSRuntime JS
@implements IAsyncDisposable

<script src="_content/TheNerdCollective.Components.BlazorServerCircuitHandler/js/blazor-reconnect.js"></script>

@code {
    /// <summary>
    /// Custom HTML for the reconnecting dialog. Use placeholder elements with IDs:
    /// - reconnect-status: Status message element
    /// - countdown-seconds: Countdown timer span
    /// - manual-reload-btn: Reload button
    /// </summary>
    [Parameter]
    public string? ReconnectingHtml { get; set; }

    /// <summary>
    /// Custom HTML for the server restart dialog (shown when circuit expires).
    /// </summary>
    [Parameter]
    public string? ServerRestartHtml { get; set; }

    /// <summary>
    /// Custom CSS to inject into the dialog (animations, styling, etc.).
    /// </summary>
    [Parameter]
    public string? CustomCss { get; set; }

    /// <summary>
    /// Optional custom HTML for deployment/maintenance mode dialog.
    /// Used when status endpoint indicates a deployment is in progress.
    /// </summary>
    [Parameter]
    public string? DeploymentHtml { get; set; }

    /// <summary>
    /// URL to a custom spinner/loading image. If not provided, uses SVG spinner.
    /// </summary>
    [Parameter]
    public string? SpinnerUrl { get; set; }

    /// <summary>
    /// Primary color for reconnection UI (default: #594AE2).
    /// </summary>
    [Parameter]
    public string PrimaryColor { get; set; } = "#594AE2";

    /// <summary>
    /// Success/restart color (default: #4CAF50).
    /// </summary>
    [Parameter]
    public string SuccessColor { get; set; } = "#4CAF50";

    /// <summary>
    /// Optional status URL to check deployment/health status.
    /// Defaults to "/reconnection-status.json" if not provided.
    /// </summary>
    [Parameter]
    public string? StatusUrl { get; set; } = "/reconnection-status.json";

    /// <summary>
    /// Enable periodic status checks to improve UX during deployments.
    /// </summary>
    [Parameter]
    public bool CheckStatus { get; set; } = true;

    /// <summary>
    /// Poll interval in milliseconds for checking status during deployments.
    /// </summary>
    [Parameter]
    public int StatusPollInterval { get; set; } = 5000;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var config = new
            {
                reconnectingHtml = ReconnectingHtml,
                serverRestartHtml = ServerRestartHtml,
                deploymentHtml = DeploymentHtml,
                customCss = CustomCss,
                spinnerUrl = SpinnerUrl,
                primaryColor = PrimaryColor,
                successColor = SuccessColor,
                statusUrl = StatusUrl,
                checkStatus = CheckStatus,
                statusPollInterval = StatusPollInterval
            };

            await JS.InvokeVoidAsync("configureBlazorReconnection", config);
        }
    }

    /// <summary>
    /// Initializes the Blazor Server Circuit Reconnection Handler.
    /// This component loads the JavaScript reconnection handler that provides:
    /// - Automatic reconnection with exponential backoff (1s â†’ 5s max)
    /// - Professional reconnection UI overlay after 5 silent attempts
    /// - Error suppression for expected disconnection errors
    /// - Graceful fallback when circuits expire
    /// 
    /// Simply add this component to your App.razor or root layout:
    /// &lt;CircuitReconnectionHandler /&gt;
    /// 
    /// Or customize the dialog:
    /// &lt;CircuitReconnectionHandler 
    ///     PrimaryColor="#FF5722" 
    ///     SpinnerUrl="/images/spinner.gif"
    ///     CustomCss="@keyframes spin { to { transform: rotate(360deg); } }" /&gt;
    /// </summary>
    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        // Component cleanup if needed
        await Task.CompletedTask;
    }
}
