@namespace TheNerdCollective.MudComponents.HarvestTimesheet
@using MudBlazor
@using TheNerdCollective.Integrations.Harvest
@using TheNerdCollective.Integrations.Harvest.Models

<div class="mud-content">
    <MudContainer MaxWidth="MaxWidth.Large" Class="py-8">
        <div class="d-flex justify-space-between align-center mb-6">
            <MudText Typo="Typo.h4" GutterBottom="true">Timesheet Registrations</MudText>
        </div>

        @if (!_passwordVerified)
        {
            <MudPaper Class="pa-8 mb-6">
                <MudStack>
                    <MudText Typo="Typo.h6">Password Required</MudText>
                    <MudTextField T="string" @bind-Value="_passwordInput" InputType="InputType.Password" 
                                  Label="Enter password" Variant="Variant.Outlined" 
                                  OnKeyDown="HandlePasswordKeyDown" />
                    @if (_passwordIncorrect)
                    {
                        <MudAlert Severity="Severity.Error">Incorrect password. Please try again.</MudAlert>
                    }
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="VerifyPassword">
                        Access Timesheets
                    </MudButton>
                </MudStack>
            </MudPaper>
        }
        else
        {
            @* Month & Year Selection *@
        <MudPaper Class="pa-6 mb-6">
            <MudGrid>
                <MudItem xs="12" sm="4" md="4" Class="d-flex align-center gap-2">
                    <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="PreviousMonth">
                        ← Previous
                    </MudButton>
                </MudItem>
                <MudItem xs="12" sm="4" md="4" Class="d-flex align-center justify-center">
                    <MudText Typo="Typo.h6">
                        <strong>@SelectedDate?.ToString("MMMM yyyy")</strong>
                    </MudText>
                </MudItem>
                <MudItem xs="12" sm="4" md="4" Class="d-flex align-center gap-2">
                    <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="NextMonth">
                        Next →
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>

        @* Timesheet Table *@
        @if (IsLoading)
        {
            <MudProgressLinear Indeterminate="true" Class="my-4" />
            <MudText Align="Align.Center" Class="py-8">Loading timesheet data...</MudText>
        }
        else if (Timesheets.Count == 0)
        {
            <MudAlert Severity="Severity.Info">No timesheet entries found for the selected month.</MudAlert>
        }
        else
        {
            <MudPaper Class="pa-6 mb-6">
                <MudTable Items="Timesheets" Hover="true" Striped="true" Bordered="true" Dense="true">
                    <HeaderContent>
                        <MudTh>Date</MudTh>
                        <MudTh>Project</MudTh>
                        <MudTh>Task</MudTh>
                        <MudTh Style="text-align: center;">Trello</MudTh>
                        <MudTh>User</MudTh>
                        <MudTh>Notes</MudTh>
                        <MudTh Style="text-align: right;">Hours</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>@context.SpentDate.ToString("dd/MM/yyyy")</MudTd>
                        <MudTd>@context.ProjectName</MudTd>
                        <MudTd>
                            <div Class="d-flex align-center gap-2">
                                <span>@context.TaskName</span>
                                @if (context.TaskName?.Contains(UnbilledKeyword) ?? false)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Color="Color.Warning" Size="Size.Small" Title="U/B" />
                                }
                            </div>
                        </MudTd>
                        <MudTd Style="text-align: center;">
                            @if (!string.IsNullOrWhiteSpace(context.ExternalReferencePermalink))
                            {
                                <MudLink Href="@context.ExternalReferencePermalink" Target="_blank" rel="noopener noreferrer" title="Open linked card">
                                    <MudIcon Icon="@Icons.Material.Filled.ViewKanban" Color="Color.Info" />
                                </MudLink>
                            }
                        </MudTd>
                        <MudTd>@context.UserName</MudTd>
                        <MudTd>@context.Notes</MudTd>
                        <MudTd Style="text-align: right;">
                            <MudText Typo="Typo.body2" Color="Color.Primary">
                                <strong>@context.Hours.ToString("F2")</strong>
                            </MudText>
                        </MudTd>
                    </RowTemplate>
                </MudTable>

                @* Summary Section *@
                <MudPaper Class="mt-6 pa-4" Elevation="0">
                    <MudGrid>
                        <MudItem xs="12" sm="6" md="3">
                            <MudText Typo="Typo.subtitle2">Billable Hours</MudText>
                            <MudText Typo="Typo.h5" Color="Color.Success">
                                <strong>@BillableHours.ToString("F2")</strong>
                            </MudText>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudText Typo="Typo.subtitle2">Total Hours</MudText>
                            <MudText Typo="Typo.h5" Color="Color.Primary">
                                <strong>@TotalHours.ToString("F2")</strong>
                            </MudText>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudText Typo="Typo.subtitle2">Hours (U/B)</MudText>
                            <MudText Typo="Typo.h5" Color="Color.Warning">
                                <strong>@UnbilledHours.ToString("F2")</strong>
                            </MudText>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudText Typo="Typo.subtitle2">Entries</MudText>
                            <MudText Typo="Typo.h5">
                                <strong>@Timesheets.Count</strong>
                            </MudText>
                        </MudItem>
                    </MudGrid>
                </MudPaper>

                @if (ShowDebugPanel)
                {
                    <MudPaper Class="mt-6 pa-4" Elevation="0">
                        @if (!string.IsNullOrEmpty(_harvestError))
                        {
                            <MudAlert Severity="Severity.Error" Class="mb-4">
                                <MudText Typo="Typo.subtitle2" Class="mb-2">Harvest Service Error</MudText>
                                <pre style="white-space: pre-wrap; word-break: break-word; font-size: 0.85rem;">@_harvestError</pre>
                            </MudAlert>
                        }
                        <MudText Typo="Typo.subtitle1">Debug: Raw Harvest entries</MudText>
                        <MudDivider Class="my-2" />
                        @if (Timesheets.Count > 0)
                        {
                            <MudExpansionPanels MultiExpansion="true" Elevation="0">
                                @foreach (var entry in Timesheets)
                                {
                                    <MudExpansionPanel Text="@($"{entry.SpentDate:dd/MM/yyyy} - {entry.ProjectName} - {entry.TaskName}")" IsInitiallyExpanded="true">
                                        <pre class="mud-pre" style="white-space: pre-wrap; word-break: break-word;">@entry.RawEntryJson</pre>
                                    </MudExpansionPanel>
                                }
                            </MudExpansionPanels>
                        }
                        else if (!string.IsNullOrEmpty(_harvestError))
                        {
                            <MudText Typo="Typo.body2" Class="text-muted">No entries available due to error.</MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Class="text-muted">No entries to display.</MudText>
                        }
                    </MudPaper>
                }
            </MudPaper>
        }
        }
    </MudContainer>
</div>
